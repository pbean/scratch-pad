# Maintainer: PinkyD <maintainer@example.com>
pkgname=scratch-pad-git
pkgver=r1.0.1.0
pkgrel=1
pkgdesc="A floating, keyboard-driven notepad designed for developers (git version)"
arch=('x86_64')
url="https://github.com/pinkydprojects/scratch-pad"
license=('MIT')
depends=('webkit2gtk' 'gtk3' 'libayatana-appindicator')
makedepends=('rust' 'nodejs' 'pnpm' 'git')
provides=('scratch-pad')
conflicts=('scratch-pad' 'scratch-pad-bin')
source=("git+https://github.com/pinkydprojects/scratch-pad.git")
sha256sums=('SKIP')

pkgver() {
    cd "$srcdir/scratch-pad"
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
    cd "$srcdir/scratch-pad"
    
    # Install Node.js dependencies
    pnpm install --frozen-lockfile
}

build() {
    cd "$srcdir/scratch-pad"
    
    # Set Rust environment
    export RUSTUP_TOOLCHAIN=stable
    export CARGO_TARGET_DIR=target
    
    # Build the frontend
    pnpm build
    
    # Build the Tauri application
    pnpm tauri build
}

check() {
    cd "$srcdir/scratch-pad"
    
    # Run frontend tests
    pnpm test --run
    
    # Run backend tests
    cd src-tauri
    cargo test --release
}

package() {
    cd "$srcdir/scratch-pad"
    
    # Install the binary
    install -Dm755 "src-tauri/target/release/scratch-pad" "$pkgdir/usr/bin/scratch-pad"
    
    # Install desktop file
    install -Dm644 "src-tauri/scratch-pad.desktop" "$pkgdir/usr/share/applications/scratch-pad.desktop"
    
    # Install icons
    for size in 32 128; do
        install -Dm644 "src-tauri/icons/${size}x${size}.png" \
            "$pkgdir/usr/share/icons/hicolor/${size}x${size}/apps/scratch-pad.png"
    done
    
    # Install license
    install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
    
    # Install documentation
    install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
    install -Dm644 docs/USER_GUIDE.md "$pkgdir/usr/share/doc/$pkgname/USER_GUIDE.md"
    install -Dm644 docs/INSTALLATION.md "$pkgdir/usr/share/doc/$pkgname/INSTALLATION.md"
}